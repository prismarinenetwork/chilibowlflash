<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 11 Desktop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Use a font similar to Windows 11's Segoe UI */
        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0; /* Ensures no default body margin causes gaps */
            padding: 0;
        }

        /* Custom text shadow for desktop icon labels */
        .icon-label {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
        }

        /* The main desktop container */
        #desktop {
            background-image: url('https://wallpapercave.com/wp/wp15039692.webp');
            background-size: cover;
            background-position: center;
        }

        /* Style the container for the icons so absolute positioning works */
        #desktop-icons {
             /* Set to full size to define the absolute positioning context */
             width: 100%;
             height: 100%;
             /* Remove flex properties since we are manually positioning icons */
             display: block;
        }

        /* Desktop Icon Base Style */
        .desktop-icon {
            /* Start position is relative so we can calculate the initial absolute position on drag */
            position: relative;
            z-index: 10;
            user-select: none;
            cursor: pointer;
            /* Flex properties from previous version for internal alignment */
            @apply flex flex-col items-center justify-start w-24 h-24 rounded-lg hover:bg-white/20 p-2 group;
        }

        /* Styling for app windows */
        .app-window {
            min-height: 150px;
            min-width: 250px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            /* Enable resizing */
            resize: both;
            overflow: hidden; /* This is key for resize to work with flex */
            /* Add backdrop blur for modern feel */
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.9);
        }

        /* Style for the title bar used as a drag handle */
        .title-bar {
            cursor: move;
            user-select: none; /* Prevent text selection while dragging */
        }

        /* Maximized window state - FIX APPLIED HERE */
        .app-window.maximized {
            /* Use viewport units (vw/vh) for reliable full screen sizing */
            width: 100vw !important;
            height: calc(100vh - 3.5rem) !important; /* Full height minus 3.5rem taskbar */
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important; /* Important to remove any residual margin */
            transform: none !important; /* Remove the centering transform */
            resize: none;
        }

        /* Hide the default iframe border */
        .window-content iframe {
            border: none;
        }

        /* Calculator button styles */
        .calc-btn {
            @apply w-full h-16 bg-gray-200 rounded-md text-2xl font-medium transition-colors duration-150 flex items-center justify-center;
        }
        .calc-btn:hover {
            @apply bg-gray-300;
        }
        .calc-btn.operator {
            @apply bg-orange-400 text-white;
        }
        .calc-btn.operator:hover {
            @apply bg-orange-500;
        }

        /* Dark Taskbar Styling */
        #taskbar {
             /* Changed from bg-white/70 to a dark grey with blur */
            background-color: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
        }
        #taskbar .taskbar-icon {
            /* Adjust hover color for dark theme */
            @apply hover:bg-white/10;
        }
        #taskbar .taskbar-icon img {
             /* Optional: Slightly adjust icon appearance if needed, but not strictly necessary */
        }
        #taskbar #clock {
             /* Change clock text color to white for visibility on dark background */
            @apply text-white;
        }
        #taskbar button {
             /* Adjust start button hover for dark theme */
            @apply hover:bg-white/10;
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden" onload="initDesktop()">

    <div id="desktop" class="w-full h-full relative">

        <div id="desktop-icons" class="relative">

            <div id="icon-word" ondblclick="openApp('word')" class="desktop-icon top-4 left-4">
                <img src="https://cdn.worldvectorlogo.com/logos/word-1.svg" alt="Word Icon" class="w-12 h-12">
                <span class="text-white text-xs text-center mt-1 icon-label">Word</span>
            </div>

            <div id="icon-retro" ondblclick="openApp('retro')" class="desktop-icon top-[110px] left-4">
                <img src="https://win98icons.alexmeub.com/icons/png/computer-3.png" alt="Retro 98 Icon" class="w-12 h-12">
                <span class="text-white text-xs text-center mt-1 icon-label">Retro</span>
            </div>

            <div id="icon-calculator" ondblclick="openApp('calculator')" class="desktop-icon top-[216px] left-4">
                <img src="https://cdn.worldvectorlogo.com/logos/windows-calculator.svg" alt="Calculator Icon" class="w-12 h-12">
                <span class="text-white text-xs text-center mt-1 icon-label">Calculator</span>
            </div>

            <div id="icon-chrome" ondblclick="openApp('chrome')" class="desktop-icon top-[322px] left-4">
                <img src="https://cdn.worldvectorlogo.com/logos/chrome.svg" alt="Chrome Icon" class="w-12 h-12">
                <span class="text-white text-xs text-center mt-1 icon-label">Chrome</span>
            </div>

            <div id="icon-jsrunner" ondblclick="openApp('jsrunner')" class="desktop-icon top-[428px] left-4">
                <svg class="w-12 h-12 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span class="text-white text-xs text-center mt-1 icon-label">JS Runner</span>
            </div>

             <div id="icon-htmlrunner" ondblclick="openApp('htmlrunner')" class="desktop-icon top-4 left-[116px]">
                <svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 8h-4m-4 0h4m-4 4h4m-4 0h4" opacity="0.5"></path></svg>
                <span class="text-white text-xs text-center mt-1 icon-label">HTML Editor</span>
            </div>
        </div>

        <div id="app-windows-container" class="absolute inset-0">
            </div>

    </div>

    <div id="taskbar" class="absolute bottom-0 left-0 right-0 h-14 bg-white/70 backdrop-blur-md flex items-center justify-between px-4 shadow-t-lg z-30">
        <div></div>

        <div class="flex items-center gap-3">
            <button onclick="toggleStartMenu()" class="w-10 h-10 rounded-md hover:bg-white/50 flex items-center justify-center transition-colors">
                <img src="https://cdn.worldvectorlogo.com/logos/microsoft-windows-22.svg" alt="Start" class="w-6 h-6">
            </button>

            <div id="running-apps" class="flex items-center gap-2">
                </div>
        </div>

        <div id="clock" class="text-xs text-gray-800 text-right">
            <div>12:00 PM</div>
            <div>11/21/2025</div>
        </div>
    </div>

    <div id="start-menu" class="absolute bottom-16 left-1/2 -translate-x-1/2 w-full max-w-2xl h-[600px] bg-white/80 backdrop-blur-lg rounded-lg shadow-2xl p-6 hidden transition-all z-40">
        <div class="relative mb-6">
            <input type="text" placeholder="Search" class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 bg-white/70 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <svg class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        </div>

        <h2 class="text-lg font-semibold mb-3">Pinned</h2>
        <div class="grid grid-cols-6 gap-4">
            <div onclick="openApp('word'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <img src="https://cdn.worldvectorlogo.com/logos/microsoft-word-2013-2019.svg" class="w-12 h-12">
                <span class="text-xs mt-1">Word</span>
            </div>

            <div onclick="openApp('retro'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <img src="https://win98icons.alexmeub.com/icons/png/computer-3.png" class="w-12 h-12">
                <span class="text-xs mt-1">Retro</span>
            </div>

            <div onclick="openApp('calculator'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <img src="https://cdn.worldvectorlogo.com/logos/windows-calculator.svg" class="w-12 h-12">
                <span class="text-xs mt-1">Calculator</span>
            </div>

            <div onclick="openApp('chrome'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <img src="https://cdn.worldvectorlogo.com/logos/chrome.svg" class="w-12 h-12">
                <span class="text-xs mt-1">Chrome</span>
            </div>

            <div onclick="openApp('jsrunner'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span class="text-xs mt-1">JS Runner</span>
            </div>

            <div onclick="openApp('htmlrunner'); toggleStartMenu();" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200/50 cursor-pointer">
                <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span class="text-xs mt-1">HTML Editor</span>
            </div>
        </div>
    </div>

    <script>
        let zIndexCounter = 10;
        let calcState = {
            display: '0',
            firstVal: null,
            operator: null,
            waitingForSecondVal: false,
        };

        // --- Icon Snapping and Collision Check Logic (REUSABLE) ---
        function snapIconToGrid(element, isInitial = false) {
            const GRID_SIZE = 106; // Width/Height of the grid cell

            // 1. Ensure the icon is absolutely positioned before calculating
            if (element.style.position !== 'absolute') {
                const rect = element.getBoundingClientRect();
                const desktopRect = document.getElementById('desktop').getBoundingClientRect();
                element.style.position = 'absolute';

                // If this is the initial setup, use the current relative position as the starting point.
                let startTop = isInitial ? (rect.top - desktopRect.top) : element.offsetTop;
                let startLeft = isInitial ? (rect.left - desktopRect.left) : element.offsetLeft;

                element.style.top = `${startTop}px`;
                element.style.left = `${startLeft}px`;
            }

            let currentTop = element.offsetTop;
            let currentLeft = element.offsetLeft;

            // Calculate Snapped Position
            let snappedTop = Math.round(currentTop / GRID_SIZE) * GRID_SIZE;
            let snappedLeft = Math.round(currentLeft / GRID_SIZE) * GRID_SIZE;

            // Enforce Bounds Check (Keep on screen)
            const taskbarHeight = document.getElementById('taskbar').offsetHeight;
            const desktopHeight = document.getElementById('desktop').clientHeight;
            const desktopWidth = document.getElementById('desktop').clientWidth;

            const maxTop = desktopHeight - element.offsetHeight - taskbarHeight - 5; // -5 for a little margin
            const maxLeft = desktopWidth - element.offsetWidth - 5;
            const minPos = 0;

            snappedTop = Math.max(minPos, Math.min(snappedTop, maxTop));
            snappedLeft = Math.max(minPos, Math.min(snappedLeft, maxLeft));

            // Collision Detection
            const allIcons = document.getElementById('desktop-icons').children;
            let collisionDetected = true;
            let maxIterations = 50;

            // Try to find a free position by shifting down one grid cell at a time
            while (collisionDetected && maxIterations > 0) {
                collisionDetected = false;
                for (let i = 0; i < allIcons.length; i++) {
                    const otherIcon = allIcons[i];
                    // Skip self and non-icon elements
                    if (otherIcon === element || !otherIcon.classList.contains('desktop-icon')) continue;

                    // Skip icons that haven't been made absolute yet (only relevant during initial run)
                    if (otherIcon.style.position !== 'absolute' && isInitial) continue;

                    const otherTop = otherIcon.offsetTop;
                    const otherLeft = otherIcon.offsetLeft;

                    if (snappedTop === otherTop && snappedLeft === otherLeft) {
                        // Collision detected! Shift the snapped position down by one grid cell
                        snappedTop += GRID_SIZE;

                        // Re-apply bounds check after shifting
                        snappedTop = Math.min(snappedTop, maxTop);

                        // If we shifted and hit the boundary, and collision still exists, stop.
                        if (snappedTop === maxTop && maxTop === otherTop) {
                            collisionDetected = false;
                            break;
                        }

                        // Set flag to re-run the check against all icons with the new snappedTop
                        collisionDetected = true;
                        break;
                    }
                }
                maxIterations--;
            }

            // Apply Final Snapped Position
            element.style.top = `${snappedTop}px`;
            element.style.left = `${snappedLeft}px`;
        }

        // --- Desktop Initialization ---
        function initDesktop() {
            updateClock();
            setInterval(updateClock, 1000); // Update clock every second

            // Close start menu if clicking on desktop
            document.getElementById('desktop').addEventListener('click', (e) => {
                const startMenu = document.getElementById('start-menu');

                // Check if the click is on the desktop itself or the icon container
                if (e.target.id === 'desktop' || e.target.id === 'desktop-icons') {
                    if (!startMenu.classList.contains('hidden')) {
                        startMenu.classList.add('hidden');
                    }
                }
            });

            // Make desktop icons draggable AND snap them to the grid immediately
            const desktopIcons = document.getElementById('desktop-icons').children;
            for (let i = 0; i < desktopIcons.length; i++) {
                // Ensure we only apply dragging to actual icon elements
                if (desktopIcons[i].classList.contains('desktop-icon')) {
                    // 1. Snap to grid first to correct initial position and apply absolute positioning
                    snapIconToGrid(desktopIcons[i], true); // true indicates initial setup

                    // 2. Then make them draggable
                    makeIconDraggable(desktopIcons[i]);
                }
            }
        }

        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString([], { month: 'numeric', day: 'numeric', year: 'numeric' });
            document.getElementById('clock').innerHTML = `<div>${time}</div><div>${date}</div>`;
        }

        // --- Start Menu ---
        function toggleStartMenu() {
            document.getElementById('start-menu').classList.toggle('hidden');
        }

        // --- App Management ---
        function openApp(appName) {
            const windowId = `window-${appName}`;
            const existingWindow = document.getElementById(windowId);

            // If window exists, just focus it
            if (existingWindow) {
                focusWindow(existingWindow);
                existingWindow.classList.remove('hidden'); // Un-minimize
                return;
            }

            // Define app properties
            let title = '';
            let contentHtml = '';
            let iconSrc = '';
            let defaultSize = 'w-5/6 max-w-3xl h-3/4'; // default

            switch(appName) {
                case 'word':
                    title = 'Word';
                    iconSrc = 'https://cdn.worldvectorlogo.com/logos/microsoft-word-2013-2019.svg';
                    // This is a simple text editor, not actual Word
                    contentHtml = `<textarea class="w-full h-full p-2 border-0 focus:outline-none resize-none" placeholder="Start typing..."></textarea>`;
                    break;
                case 'retro': // Replaced 'paint'
                    title = 'Retro';
                    iconSrc = 'https://win98icons.alexmeub.com/icons/png/computer-3.png';

                    contentHtml = `<iframe src="https://winxp.now.sh" class="w-full h-full"></iframe>`;
                    defaultSize = 'w-5/6 max-w-4xl h-5/6'; // Needs more space
                    break;
                case 'calculator':
                    title = 'Calculator';
                    iconSrc = 'https://cdn.worldvectorlogo.com/logos/windows-calculator.svg';
                    contentHtml = createCalculatorHTML();
                    defaultSize = 'w-80 h-auto'; // Fixed size for calculator
                    break;
                case 'chrome':
                    title = 'Chrome';
                    iconSrc = 'https://cdn.worldvectorlogo.com/logos/chrome.svg';

                    contentHtml = `
                        <div class="w-full h-full flex flex-col">
                            <div class="p-2 bg-gray-100 border-b flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                                <input type="text" value="about:blank" onkeydown="event.stopPropagation()" class="w-full bg-white border rounded-full px-3 py-1 text-sm">
                            </div>
                            <iframe
                                src="https://eaglercraft.mywire.org/diablo.html"
                                class="w-full h-full flex-grow"
                                sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-top-navigation allow-modals"
                                allow="fullscreen; pointer-lock"
                            ></iframe>
                        </div>`;
                    break;
                case 'jsrunner':
                    title = 'JS Runner';
                    // Base64 encoded SVG for taskbar icon
                    iconSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNIDEwIDIwIGwgNCAtMTYgbSA0IDQgbCA0IDQgLSA0IDQgbSAwIC04IGwgLSA0IC00IGwgNCAtNCBNIDYgMTYgbCAtNCAtNCBsIDQgLTQiIC8+PC9zdmc+';
                    contentHtml = createJSRunnerHTML(windowId);
                    defaultSize = 'w-5/6 max-w-xl h-5/6';
                    break;
                case 'htmlrunner':
                    title = 'HTML Editor';
                    // Base64 encoded SVG for HTML/Brackets
                    iconSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTQgMTBIMTBtLTQgMGgyMCIgLz48cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik03IDhsLTQgNGw0IDRNMTcgOGw0IDRsLTQgNG00LTRoLTYiIC8+PC9zdmc+'; // Simplified bracket icon
                    contentHtml = createHTMLRunnerHTML(windowId);
                    defaultSize = 'w-5/6 max-w-4xl h-5/6';
                    break;
            }

            createWindow(appName, title, contentHtml, defaultSize);
            createTaskbarIcon(appName, iconSrc);
        }

        function createWindow(appName, title, contentHtml, size) {
            const windowId = `window-${appName}`;
            const windowEl = document.createElement('div');
            windowEl.id = windowId;
            windowEl.className = `app-window absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg flex flex-col ${size}`;
            windowEl.style.zIndex = ++zIndexCounter;

            windowEl.innerHTML = `
                <div class="title-bar h-8 bg-gray-100 flex justify-between items-center px-3 rounded-t-lg border-b">
                    <span class="text-sm font-semibold text-gray-700">${title}</span>
                    <div class="flex items-center gap-2">
                        <button onclick="minimizeWindow('${windowId}')" class="w-5 h-5 rounded-full bg-yellow-400 hover:bg-yellow-500"></button>
                        <button onclick="maximizeWindow('${windowId}')" class="w-5 h-5 rounded-full bg-green-400 hover:bg-green-500"></button>
                        <button onclick="closeApp('${appName}')" class="w-5 h-5 rounded-full bg-red-500 hover:bg-red-600"></button>
                    </div>
                </div>
                <div class="window-content flex-grow relative ${appName === 'calculator' ? 'p-2 bg-gray-100' : ''}">
                    ${contentHtml}
                </div>
            `;

            document.getElementById('app-windows-container').appendChild(windowEl);
            makeDraggable(windowEl);

            // Focus on creation
            windowEl.addEventListener('mousedown', () => focusWindow(windowEl), true);

            // FIX: Initialize Calculator Display after creation
            if (appName === 'calculator') {
                updateCalcDisplay();
            }
        }

        function closeApp(appName) {
            const windowId = `window-${appName}`;
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
                windowEl.remove();
            }

            const taskbarIcon = document.querySelector(`.taskbar-icon[data-app="${appName}"]`);
            if (taskbarIcon) {
                taskbarIcon.remove();
            }
        }

        function minimizeWindow(windowId) {
            document.getElementById(windowId).classList.add('hidden');
        }

        function maximizeWindow(windowId) {
            document.getElementById(windowId).classList.toggle('maximized');
        }

        function focusWindow(windowEl) {
            // Un-minimize if it was hidden
            windowEl.classList.remove('hidden');

            // Bring to front
            windowEl.style.zIndex = ++zIndexCounter;

            // Highlight taskbar icon (optional future feature)
            // const appName = windowEl.id.split('-')[1];
            // document.querySelectorAll('.taskbar-icon').forEach(icon => icon.classList.remove('ring-2', 'ring-blue-500'));
            // document.querySelector(`.taskbar-icon[data-app="${appName}"]`)?.classList.add('ring-2', 'ring-blue-500');
        }

        function createTaskbarIcon(appName, iconSrc) {
            const taskbarIcon = document.createElement('button');
            // Class uses dark theme hover adjustment from the CSS style block
            taskbarIcon.className = 'taskbar-icon w-10 h-10 rounded-md hover:bg-white/50 flex items-center justify-center transition-colors p-1';
            taskbarIcon.dataset.app = appName;
            // Use an SVG or image URL
            if (iconSrc.startsWith('data:')) {
                taskbarIcon.innerHTML = `<img src="${iconSrc}" class="w-6 h-6">`;
            } else {
                taskbarIcon.innerHTML = `<img src="${iconSrc}" class="w-8 h-8">`;
            }

            taskbarIcon.onclick = () => {
                const windowEl = document.getElementById(`window-${appName}`);
                if (windowEl) {
                    focusWindow(windowEl);
                }
            };

            document.getElementById('running-apps').appendChild(taskbarIcon);
        }

        // --- Window Dragging Logic (For App Windows) ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const titleBar = element.querySelector('.title-bar');

            if (titleBar) {
                titleBar.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();

                // Only allow dragging if not maximized
                if (element.classList.contains('maximized')) return;

                // Get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;

                // Focus window on drag start
                focusWindow(element);

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Don't drag if maximized
                if (element.classList.contains('maximized')) return;

                // Calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // Set the element's new position:
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // Stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;

                // --- FIX: Force focus back to iframe content after drag finishes ---
                const iframe = element.querySelector('iframe');
                if (iframe) {
                    iframe.focus();
                }
            }
        }

        // --- Icon Dragging Logic (For Desktop Icons) ---
        function makeIconDraggable(element) {
            let pos3 = 0, pos4 = 0; // Mouse start position

            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;

                // Convert position to absolute on first drag (this is now handled by initDesktop, but kept as a fallback/safety)
                if (element.style.position !== 'absolute') {
                    const rect = element.getBoundingClientRect();
                    const desktopRect = document.getElementById('desktop').getBoundingClientRect();
                    element.style.position = 'absolute';
                    element.style.top = `${rect.top - desktopRect.top}px`;
                    element.style.left = `${rect.left - desktopRect.left}px`;
                }

                // Get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;

                e.preventDefault();
            }

            function elementDrag(e) {
                e = e || window.event;

                // Calculate the new cursor position:
                let pos1 = pos3 - e.clientX;
                let pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                // Set the element's new position (temporary, before snapping):
                let newTop = (element.offsetTop - pos2);
                let newLeft = (element.offsetLeft - pos1);

                // Set the temporary position immediately for smooth dragging
                element.style.top = `${newTop}px`;
                element.style.left = `${newLeft}px`;
            }

            function closeDragElement() {
                // Stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;

                // Call the unified snap function to handle snapping, bounds, and collision
                snapIconToGrid(element, false);
            }
        }


        // --- Calculator App Logic ---
        function createCalculatorHTML() {
            const buttons = [
                'C', '+/-', '%', '/',
                '7', '8', '9', '*',
                '4', '5', '6', '-',
                '1', '2', '3', '+',
                '0', '.', '='
            ];

            let html = '<div id="calc-display" class="w-full h-20 bg-gray-100 text-right text-5xl font-light pr-4 pt-4 mb-2 rounded-md break-all">0</div>';
            html += '<div class="grid grid-cols-4 gap-2">';

            buttons.forEach(btn => {
                let classes = 'calc-btn';
                if (['/', '*', '-', '+', '='].includes(btn)) classes += ' operator';
                if (btn === '0') classes += ' col-span-2';
                html += `<button class="text-xl ${classes}" onclick="handleCalcInput('${btn}')">${btn}</button>`;
            });

            html += '</div>';
            return html;
        }

        function updateCalcDisplay() {
            const displayEl = document.getElementById('calc-display');
            if (displayEl) {
                displayEl.innerText = calcState.display;
            }
        }

        function handleCalcInput(value) {
            if (!isNaN(Number(value)) || value === '.') {
                // Handle number and decimal input
                if (calcState.waitingForSecondVal) {
                    // Check if value is '.' and display already contains it
                    if (value === '.' && calcState.display.includes('.')) return;
                    calcState.display = value;
                    calcState.waitingForSecondVal = false;
                } else {
                    // Prevent multiple leading zeros unless followed by a decimal
                    if (calcState.display === '0' && value !== '.') {
                        calcState.display = value;
                    } else if (value === '.' && calcState.display.includes('.')) {
                        return; // Prevent multiple decimals
                    } else {
                        calcState.display += value;
                    }
                }
            } else if (value === 'C') {
                // Clear
                calcState.display = '0';
                calcState.firstVal = null;
                calcState.operator = null;
                calcState.waitingForSecondVal = false;
            } else if (value === '+/-') {
                // Plus/Minus
                calcState.display = (parseFloat(calcState.display) * -1).toString();
            } else if (value === '%') {
                // Percentage
                calcState.display = (parseFloat(calcState.display) / 100).toString();
            } else if (value === '=') {
                // Equals
                if (calcState.firstVal !== null && calcState.operator !== null) {
                    calcState.display = calculate(calcState.firstVal, parseFloat(calcState.display), calcState.operator);
                    calcState.firstVal = null;
                    calcState.operator = null;
                    calcState.waitingForSecondVal = false;
                }
            } else {
                // Operator
                if (calcState.operator !== null && !calcState.waitingForSecondVal) {
                    // Chain operations: 1 + 2 + 3
                    calcState.display = calculate(calcState.firstVal, parseFloat(calcState.display), calcState.operator);
                }
                calcState.firstVal = parseFloat(calcState.display);
                calcState.operator = value;
                calcState.waitingForSecondVal = true;
            }

            updateCalcDisplay();
        }

        function calculate(val1, val2, operator) {
            let result = 0;
            switch(operator) {
                case '+': result = val1 + val2; break;
                case '-': result = val1 - val2; break;
                case '*': result = val1 * val2; break;
                case '/':
                    if (val2 === 0) return 'Error'; // Division by zero check
                    result = val1 / val2;
                    break;
            }
            // Fix floating point issues
            return parseFloat(result.toPrecision(15)).toString();
        }

        // --- JS Runner App Logic ---
        function createJSRunnerHTML(windowId) {
            return `
                <div class="p-4 flex flex-col h-full space-y-3 bg-gray-50 overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-700">Input JavaScript code in here to be ran:</h3>

                    <textarea id="js-code-${windowId}"
                              class="w-full h-1/2 p-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 resize-none shadow-inner"
                              placeholder="Example: console.log(2 + 2);&#10;let x = 'Runner';&#10;return 'JS ' + x;"></textarea>

                    <button onclick="executeJSRunnerCode('${windowId}')" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-150 font-bold shadow-md">
                        Execute !
                    </button>

                    <div class="flex-grow flex flex-col border border-gray-400 rounded-lg p-3 bg-gray-800 overflow-y-auto">
                        <h3 class="text-sm font-medium text-green-400 mb-1 border-b border-green-500/20 pb-1">Output Console:</h3>
                        <pre id="js-output-${windowId}" class="text-xs text-white whitespace-pre-wrap flex-grow font-mono leading-relaxed"></pre>
                    </div>
                </div>
            `;
        }

        function executeJSRunnerCode(windowId) {
            const codeEl = document.getElementById(`js-code-${windowId}`);
            const outputEl = document.getElementById(`js-output-${windowId}`);
            const userCode = codeEl.value;

            // Clear previous output
            outputEl.textContent = '';
            outputEl.style.color = 'white'; // Reset color from potential error state

            // Store original console.log
            const originalConsoleLog = console.log;
            let output = '';

            // Override console.log to capture output
            console.log = function(...args) {
                // Convert arguments to a string representation
                const message = args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');

                output += message + '\n';
                // Call the original console.log for browser debugging
                originalConsoleLog.apply(console, args);
            };

            try {
                // Execute the code safely using Function constructor
                const result = (new Function(userCode))();

                if (output) {
                    outputEl.textContent = output.trim();
                } else if (result !== undefined) {
                    // If no console output, show the return value of the script
                    outputEl.textContent = `[Return Value]\n${result}`;
                } else {
                    outputEl.textContent = 'Code executed successfully (no console output or return value).';
                }

            } catch (error) {
                // Display error message
                outputEl.textContent = `[EXECUTION ERROR]\n${error.name}: ${error.message}`;
                outputEl.style.color = 'rgb(252 165 165)'; // Tailored red color
            } finally {
                // Restore original console.log immediately
                console.log = originalConsoleLog;
            }
        }

        // --- HTML Runner App Logic (NEW) ---
        function createHTMLRunnerHTML(windowId) {
            return `
                <div class="grid grid-cols-2 h-full bg-gray-50 overflow-hidden divide-x divide-gray-200">
                    <div class="flex flex-col h-full p-2 space-y-2">
                        <h3 class="text-sm font-semibold text-gray-700">Code (HTML/CSS/JS):</h3>
                        <textarea id="html-code-${windowId}"
                                  class="w-full flex-grow p-2 border border-gray-300 rounded-lg text-xs font-mono focus:ring-2 focus:ring-purple-500 resize-none shadow-inner"
                                  placeholder="Type your HTML code here, including <style> and <script> tags.">
<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #e0f7fa; }
        h1 { color: #00bcd4; }
    </style>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>This is rendered from the HTML Editor.</p>
</body>
</html>
</textarea>
                        <button onclick="runHTMLRunnerCode('${windowId}')" class="bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition duration-150 font-bold shadow-md">
                            Run HTML/Preview
                        </button>
                    </div>

                    <div class="flex flex-col h-full p-2">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Live Preview:</h3>
                        <iframe id="html-output-${windowId}"
                                sandbox="allow-scripts allow-same-origin"
                                class="w-full flex-grow border border-gray-400 rounded-lg bg-white"></iframe>
                    </div>
                </div>
            `;
        }

        function runHTMLRunnerCode(windowId) {
            const codeEl = document.getElementById(`html-code-${windowId}`);
            const outputIframe = document.getElementById(`html-output-${windowId}`);
            const userCode = codeEl.value;

            // Set the iframe's content directly using srcdoc.
            // The sandbox attribute in the iframe tag ensures safety.
            outputIframe.srcdoc = userCode;
        }

    </script>

</body>
</html>
